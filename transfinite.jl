function transfinite_blend_3D(xcorners, ycorners, zcorners)

    


  (x1, x2, x3, x4, x5, x6, x7, x8) = xcorners
  (y1, y2, y3, y4, y5, y6, y7, y8) = ycorners
  (z1, z2, z3, z4, z5, z6, z7, z8) = zcorners



  #Define 12 edges for each of x, y, z:
  ex = [(α) -> x1 * (1 .- α) / 2 + x5 * (1 .+ α) / 2,
        (α) -> x2 * (1 .- α) / 2 + x6 * (1 .+ α) / 2,
        (α) -> x3 * (1 .- α) / 2 + x7 * (1 .+ α) / 2,
        (α) -> x4 * (1 .- α) / 2 + x8 * (1 .+ α) / 2,

        (α) -> x1 * (1 .- α) / 2 + x3 * (1 .+ α) / 2,
        (α) -> x2 * (1 .- α) / 2 + x4 * (1 .+ α) / 2,
        (α) -> x5 * (1 .- α) / 2 + x7 * (1 .+ α) / 2,
        (α) -> x6 * (1 .- α) / 2 + x8 * (1 .+ α) / 2,

        (α) -> x1 * (1 .- α) / 2 + x2 * (1 .+ α) / 2,
        (α) -> x3 * (1 .- α) / 2 + x4 * (1 .+ α) / 2,
        (α) -> x5 * (1 .- α) / 2 + x6 * (1 .+ α) / 2,
        (α) -> x7 * (1 .- α) / 2 + x8 * (1 .+ α) / 2]

  dex = [(α) -> x1 * (-1) / 2 + x5 * (1) / 2,
        (α) -> x2 * (-1) / 2 + x6 * (1) / 2,
        (α) -> x3 * (-1) / 2 + x7 * (1) / 2,
        (α) -> x4 * (-1) / 2 + x8 * (1) / 2,

        (α) -> x1 * (-1) / 2 + x3 * (1) / 2,
        (α) -> x2 * (-1) / 2 + x4 * (1) / 2,
        (α) -> x5 * (-1) / 2 + x7 * (1) / 2,
        (α) -> x6 * (-1) / 2 + x8 * (1) / 2,

        (α) -> x1 * (-1) / 2 + x2 * (1) / 2,
        (α) -> x3 * (-1) / 2 + x4 * (1) / 2,
        (α) -> x5 * (-1) / 2 + x6 * (1) / 2,
        (α) -> x7 * (-1) / 2 + x8 * (1) / 2]

  ey = [(α) -> y1 * (1 .- α) / 2 + y5 * (1 .+ α) / 2,
        (α) -> y2 * (1 .- α) / 2 + y6 * (1 .+ α) / 2,
        (α) -> y3 * (1 .- α) / 2 + y7 * (1 .+ α) / 2,
        (α) -> y4 * (1 .- α) / 2 + y8 * (1 .+ α) / 2,

        (α) -> y1 * (1 .- α) / 2 + y3 * (1 .+ α) / 2,
        (α) -> y2 * (1 .- α) / 2 + y4 * (1 .+ α) / 2,
        (α) -> y5 * (1 .- α) / 2 + y7 * (1 .+ α) / 2,
        (α) -> y6 * (1 .- α) / 2 + y8 * (1 .+ α) / 2,

        (α) -> y1 * (1 .- α) / 2 + y2 * (1 .+ α) / 2,
        (α) -> y3 * (1 .- α) / 2 + y4 * (1 .+ α) / 2,
        (α) -> y5 * (1 .- α) / 2 + y6 * (1 .+ α) / 2,
        (α) -> y7 * (1 .- α) / 2 + y8 * (1 .+ α) / 2]

  dey = [(α) -> y1 * (-1) / 2 + y5 * (1) / 2,
        (α) -> y2 * (-1) / 2 + y6 * (1) / 2,
        (α) -> y3 * (-1) / 2 + y7 * (1) / 2,
        (α) -> y4 * (-1) / 2 + y8 * (1) / 2,

        (α) -> y1 * (-1) / 2 + y3 * (1) / 2,
        (α) -> y2 * (-1) / 2 + y4 * (1) / 2,
        (α) -> y5 * (-1) / 2 + y7 * (1) / 2,
        (α) -> y6 * (-1) / 2 + y8 * (1) / 2,

        (α) -> y1 * (-1) / 2 + y2 * (1) / 2,
        (α) -> y3 * (-1) / 2 + y4 * (1) / 2,
        (α) -> y5 * (-1) / 2 + y6 * (1) / 2,
        (α) -> y7 * (-1) / 2 + y8 * (1) / 2]

  ez = [(α) -> z1 * (1 .- α) / 2 + z5 * (1 .+ α) / 2,
        (α) -> z2 * (1 .- α) / 2 + z6 * (1 .+ α) / 2,
        (α) -> z3 * (1 .- α) / 2 + z7 * (1 .+ α) / 2,
        (α) -> z4 * (1 .- α) / 2 + z8 * (1 .+ α) / 2,

        (α) -> z1 * (1 .- α) / 2 + z3 * (1 .+ α) / 2,
        (α) -> z2 * (1 .- α) / 2 + z4 * (1 .+ α) / 2,
        (α) -> z5 * (1 .- α) / 2 + z7 * (1 .+ α) / 2,
        (α) -> z6 * (1 .- α) / 2 + z8 * (1 .+ α) / 2,

        (α) -> z1 * (1 .- α) / 2 + z2 * (1 .+ α) / 2,
        (α) -> z3 * (1 .- α) / 2 + z4 * (1 .+ α) / 2,
        (α) -> z5 * (1 .- α) / 2 + z6 * (1 .+ α) / 2,
        (α) -> z7 * (1 .- α) / 2 + z8 * (1 .+ α) / 2]

    dez = [(α) -> z1 * (-1) / 2 + z5 * (1) / 2,
        (α) -> z2 * (-1) / 2 + z6 * (1) / 2,
        (α) -> z3 * (-1) / 2 + z7 * (1) / 2,
        (α) -> z4 * (-1) / 2 + z8 * (1) / 2,

        (α) -> z1 * (-1) / 2 + z3 * (1) / 2,
        (α) -> z2 * (-1) / 2 + z4 * (1) / 2,
        (α) -> z5 * (-1) / 2 + z7 * (1) / 2,
        (α) -> z6 * (-1) / 2 + z8 * (1) / 2,

        (α) -> z1 * (-1) / 2 + z2 * (1) / 2,
        (α) -> z3 * (-1) / 2 + z4 * (1) / 2,
        (α) -> z5 * (-1) / 2 + z6 * (1) / 2,
        (α) -> z7 * (-1) / 2 + z8 * (1) / 2]
      #Define 6 faces for each x, y and z:
    fx, dfx = blend_edges(ex)
    fy, dfy = blend_edges(ey)
    fz, dfz = blend_edges(ez)


    # x(q, r, s), xq(q, r, s), xr(q, r, s), xs(q, r, s) = transfinite_blend_3Dcomp(fx, ex, q, r, s)
    # y(q, r, s), yq(q, r, s), yr(q, r, s), ys(q, r, s) = transfinite_blend_3Dcomp(fy, ey, q, r, s)
    # z(q, r, s), zq(q, r, s), zr(q, r, s), zs(q, r, s) = transfinite_blend_3Dcomp(fz, ez, q, r, s)
    
  
    xf = (q,r,s) -> transfinite_blend_3Dcomp(fx, ex, dfx, dex, q, r, s)
    yf = (q,r,s) -> transfinite_blend_3Dcomp(fy, ey, dfy, dey, q, r, s)
    zf = (q,r,s) -> transfinite_blend_3Dcomp(fz, ez, dfz, dez, q, r, s)

   
    # xf = x
    # yf = y
    # zf = z
    # q = range(-1, stop=1, length=Nqp)
    # r = range(-1, stop=1, length=Nrp)
    # s = range(-1, stop=1, length=Nsp)

    # # Create the mesh

    # q = (q * ones(1, Nqp)) .* reshape(ones(Nqp), 1, 1, :)
    # r = (ones(Nrp) * r') .* reshape(ones(Nrp), 1, 1, :)
    # s = (ones(Nsp) * ones(1, Nsp)) .* reshape(s, 1, 1, :) # possible source for error? 

    # X = x(q,r,s)
    # Y = y(q,r,s)
    # Z = z(q,r,s)


  return (xf, yf, zf)

end



function blend_edges(e)
  f1 = (r, s) ->  (1 .- r) .* e[1](s) / 2 .+ (1 .+ r) .* e[3](s) / 2 .+ 
                (1 .- s) .* e[5](r) / 2 .+ (1 .+ s) .* e[7](r) / 2 .- 
              ( (1 .+ r) .* (1 .+ s) .* e[3]( 1) +
                (1 .- r) .* (1 .+ s) .* e[1]( 1) +
                (1 .+ r) .* (1 .- s) .* e[3](-1) +
                (1 .- r) .* (1 .- s) .* e[1](-1)) / 4

  f2 = (r, s) ->  (1 .- r) .* e[2](s) / 2 .+ (1 .+ r) .* e[4](s) / 2 .+ 
                (1 .- s) .* e[6](r) / 2 .+ (1 .+ s) .* e[8](r) / 2 .- 
              ( (1 .+ r) .* (1 .+ s) .* e[4]( 1) +
                (1 .- r) .* (1 .+ s) .* e[2]( 1) +
                (1 .+ r) .* (1 .- s) .* e[4](-1) +
                (1 .- r) .* (1 .- s) .* e[2](-1)) / 4

  f3 = (q, s) ->  (1 .- q) .* e[1](s) / 2 .+ (1 .+ q) .* e[2](s) / 2 .+ 
                (1 .- s) .* e[9](q) / 2 .+ (1 .+ s) .* e[11](q) / 2 .- 
              ( (1 .+ q) .* (1 .+ s) .* e[2]( 1) +
                (1 .- q) .* (1 .+ s) .* e[1]( 1) +
                (1 .+ q) .* (1 .- s) .* e[2](-1) +
                (1 .- q) .* (1 .- s) .* e[1](-1)) / 4

  f4 = (q, s) ->  (1 .- q) .* e[3](s) / 2 .+ (1 .+ q) .* e[4](s) / 2 .+ 
                (1 .- s) .* e[10](q) / 2 .+ (1 .+ s) .* e[12](q) / 2 .- 
              ( (1 .+ q) .* (1 .+ s) .* e[4]( 1) +
                (1 .- q) .* (1 .+ s) .* e[3]( 1) +
                (1 .+ q) .* (1 .- s) .* e[4](-1) +
                (1 .- q) .* (1 .- s) .* e[3](-1)) / 4

  f5 = (q, r) ->  (1 .- q) .* e[5](r) / 2 .+ (1 .+ q) .* e[6](r) / 2 .+ 
                (1 .- r) .* e[9](q) / 2 .+ (1 .+ r) .* e[10](q) / 2 .- 
              ( (1 .+ q) .* (1 .+ r) .* e[6]( 1) +
                (1 .- q) .* (1 .+ r) .* e[5]( 1) +
                (1 .+ q) .* (1 .- r) .* e[6](-1) +
                (1 .- q) .* (1 .- r) .* e[5](-1)) / 4

  f6 = (q, r) ->  (1 .- q) .* e[7](r) / 2 .+ (1 .+ q) .* e[8](r) / 2 .+ 
                (1 .- r) .* e[11](q) / 2 .+ (1 .+ r) .* e[12](q) / 2 .- 
              ( (1 .+ q) .* (1 .+ r) .* e[8]( 1) +
                (1 .- q) .* (1 .+ r) .* e[7]( 1) +
                (1 .+ q) .* (1 .- r) .* e[8](-1) +
                (1 .- q) .* (1 .- r) .* e[7](-1)) / 4


  # partial derivatives

  f1q = (r, s) ->  0 

  f1r = (r, s) ->  (-1) .* e[1](s) / 2 .+ (1) .* e[3](s) / 2 .+ 
                (1 .- s) .* er[5](r) / 2 .+ (1 .+ s) .* er[7](r) / 2 .- 
              ( (1) .* (1 .+ s) .* e[3]( 1) +
                (-1) .* (1 .+ s) .* e[1]( 1) +
                (1) .* (1 .- s) .* e[3](-1) +
                (-1) .* (1 .- s) .* e[1](-1)) / 4

  f1s = (r, s) ->  (1 .- r) .* es[1](s) / 2 .+ (1 .+ r) .* es[3](s) / 2 .+ 
                (-1) .* e[5](r) / 2 .+ (1) .* e[7](r) / 2 .- 
              ( (1 .+ r) .* (1) .* e[3]( 1) +
                (1 .- r) .* (1) .* e[1]( 1) +
                (1 .+ r) .* (-1) .* e[3](-1) +
                (1 .- r) .* (-1) .* e[1](-1)) / 4

  f2q = 0
                
  f2r = (r, s) ->  (-1) .* e[2](s) / 2 .+ (1) .* e[4](s) / 2 .+ 
                (1 .- s) .* er[6](r) / 2 .+ (1 .+ s) .* er[8](r) / 2 .- 
              ( (1) .* (1 .+ s) .* e[4]( 1) +
                (-1) .* (1 .+ s) .* e[2]( 1) +
                (1) .* (1 .- s) .* e[4](-1) +
                (-1) .* (1 .- s) .* e[2](-1)) / 4

  f2s = (r, s) ->  (1 .- r) .* es[2](s) / 2 .+ (1 .+ r) .* es[4](s) / 2 .+ 
                (-1) .* e[6](r) / 2 .+ (1) .* e[8](r) / 2 .- 
              ( (1 .+ r) .* (1) .* e[4]( 1) +
                (1 .- r) .* (1) .* e[2]( 1) +
                (1 .+ r) .* (-1) .* e[4](-1) +
                (1 .- r) .* (-1) .* e[2](-1)) / 4


    f3q = (q, s) ->  (-1) .* e[1](s) / 2 .+ (1) .* e[2](s) / 2 .+ 
                (1 .- s) .* eq[9](q) / 2 .+ (1 .+ s) .* eq[11](q) / 2 .- 
              ( (1) .* (1 .+ s) .* e[2]( 1) +
                (-1) .* (1 .+ s) .* e[1]( 1) +
                (1) .* (1 .- s) .* e[2](-1) +
                (-1) .* (1 .- s) .* e[1](-1)) / 4
    f3r = 0

    f3s = (q, s) ->  (1 .- q) .* es[1](s) / 2 .+ (1 .+ q) .* es[2](s) / 2 .+ 
                (-1) .* e[9](q) / 2 .+ (1) .* e[11](q) / 2 .- 
              ( (1 .+ q) .* (1) .* e[2]( 1) +
                (1 .- q) .* (1) .* e[1]( 1) +
                (1 .+ q) .* (-1) .* e[2](-1) +
                (1 .- q) .* (-1) .* e[1](-1)) / 4

    f4q = (q, s) ->  (-1) .* e[3](s) / 2 .+ (1) .* e[4](s) / 2 .+ 
                (1 .- s) .* eq[10](q) / 2 .+ (1 .+ s) .* eq[12](q) / 2 .- 
              ( (1) .* (1 .+ s) .* e[4]( 1) +
                (-1) .* (1 .+ s) .* e[3]( 1) +
                (1) .* (1 .- s) .* e[4](-1) +
                (-1) .* (1 .- s) .* e[3](-1)) / 4
                
      f4r = (q, s) ->  0

      f4s = (q, s) ->  (1 .- q) .* es[3](s) / 2 .+ (1 .+ q) .* es[4](s) / 2 .+ 
                (-1) .* e[10](q) / 2 .+ (1) .* e[12](q) / 2 .- 
              ( (1 .+ q) .* (1) .* e[4]( 1) +
                (1 .- q) .* (1) .* e[3]( 1) +
                (1 .+ q) .* (-1) .* e[4](-1) +
                (1 .- q) .* (-1) .* e[3](-1)) / 4


                f5q = (q, r) ->  (-1) .* e[5](r) / 2 .+ (1) .* e[6](r) / 2 .+ 
                (1 .- r) .* eq[9](q) / 2 .+ (1 .+ r) .* eq[10](q) / 2 .- 
              ( (1) .* (1 .+ r) .* e[6]( 1) +
                (-1) .* (1 .+ r) .* e[5]( 1) +
                (1) .* (1 .- r) .* e[6](-1) +
                (-1) .* (1 .- r) .* e[5](-1)) / 4


                f5r = (q, r) ->  (1 .- q) .* er[5](r) / 2 .+ (1 .+ q) .* er[6](r) / 2 .+ 
                (-1) .* e[9](q) / 2 .+ (1) .* e[10](q) / 2 .- 
              ( (1 .+ q) .* (1) .* e[6]( 1) +
                (1 .- q) .* (1) .* e[5]( 1) +
                (1 .+ q) .* (-1) .* e[6](-1) +
                (1 .- q) .* (-1) .* e[5](-1)) / 4


                f5s = 0

                f6q = (q, r) ->  (-1) .* e[7](r) / 2 .+ (1) .* e[8](r) / 2 .+ 
                (1 .- r) .* eq[11](q) / 2 .+ (1 .+ r) .* eq[12](q) / 2 .- 
              ( (1) .* (1 .+ r) .* e[8]( 1) +
                (-1) .* (1 .+ r) .* e[7]( 1) +
                (1) .* (1 .- r) .* e[8](-1) +
                (-1) .* (1 .- r) .* e[7](-1)) / 4
                
                f6r = (q, r) ->  (1 .- q) .* er[7](r) / 2 .+ (1 .+ q) .* er[8](r) / 2 .+ 
                (-1) .* e[11](q) / 2 .+ (1) .* e[12](q) / 2 .- 
              ( (1 .+ q) .* (1) .* e[8]( 1) +
                (1 .- q) .* (1) .* e[7]( 1) +
                (1 .+ q) .* (-1) .* e[8](-1) +
                (1 .- q) .* (-1) .* e[7](-1)) / 4

                f6s = (q, r) -> 0
  
  f = f1, f2, f3, f4, f5, f6
  df = f1q, f1r, f1s, f2q, f2r, f2s, f3q, f3r, f3s, f4q, f4r, f4s, f5q, f5r, f5s, f6q, f6r, f6s
  return (f, df)
end




#{{{ Transfinite Blend: 6 faces f, 12 edges e and 8 corners c
function transfinite_blend_3Dcomp(f, e, df, de, q, r, s)

  

   #@assert [α1(-1) α2(-1) α1( 1) α2( 1)] ≈ [α3(-1) α3( 1) α4(-1) α4( 1)]

    # See https://www.researchgate.net/publication/265361548_The_Fundamentals_of_Grid_Generation/link/572fd53908ae744151904dc9/download?_tp=eyJjb250ZXh0Ijp7ImZpcnN0UGFnZSI6InB1YmxpY2F0aW9uIiwicGFnZSI6InB1YmxpY2F0aW9uIn19 
    # (chapter 9)
    # OR (with errors in it) http://ebrary.free.fr/Mesh%20Generation/Handbook_of_Grid_%20Generation,1999/chap03.pdf

    (f1, f2, f3, f4, f5, f6) = f 
    (e1, e2, e3, e4, e5, e6, e7, e8, e9, e10, e11, e12) = e

    (f1q, f1r, f1s, f2q, f2r, f2s, f3q, f3r, f3s, f4q, f4r, f4s, f5q, f5r, f5s, f6q, f6r, f6s) = df
    (e1q, e1r, e1s, e2q, e2r, e2s, e3q, e3r, e3s, e4q, e4r, e4s, e5q, e5r, e5s, e6q, e6r, e6s) = de

    # assert than 8 corners meet up with edges - dumb!
    @assert e1(-1) == e9(-1) == e5(-1)
    @assert e2(-1) == e9(1) == e6(-1)
    @assert e5(1) == e10(-1) == e3(-1)
    @assert e10(1) == e6(1) == e4(-1)

    @assert e7(-1) == e11(-1) == e1(1)
    @assert e11(1) == e2(1) == e8(-1)
    @assert e7(1) == e12(-1) == e3(1)
    @assert e12(1) == e8(1) == e4(1)

    U = (1 .- q) .* f1(r, s) / 2 + (1 .+ q) .* f2(r, s) / 2
    V = (1 .- r) .* f3(q, s) / 2 + (1 .+ r) .* f4(q, s) / 2
    W = (1 .- s) .* f5(q, r) / 2 + (1 .+ s) .* f6(q, r) / 2

    UV = (1 .- q) .* (1 .- r) .* e1(s) / 4 .+ (1 .- q) .* (1 .+ r) .* e3(s) / 4 .+ 
    (1 .+ q) .* (1 .- r) .* e2(s) / 4 .+ (1 .+ q) .* (1 .+ r) .* e4(s) / 4

    UW = (1 .- q) .* (1 .- s) .* e5(r) / 4 .+ (1 .- q) .* (1 .+ s) .* e7(r) / 4 .+ 
    (1 .+ q) .* (1 .- s) .* e6(r) / 4 .+ (1 .+ q) .* (1 .+ s) .* e8(r) / 4

    VW = (1 .- r) .* (1 .- s) .* e9(q) / 4  .+ (1 .- r) .* (1 .+ s) .* e11(q) / 4 .+ 
    (1 .+ r) .* (1 .- s) .* e10(q) / 4 .+ (1 .+ r) .* (1 .+ s) .* e12(q) / 4

    UVW = (1 .- q) .* (1 .- r) .* (1 .- s) .* e1(-1) ./ 8 .+ (1 .- q) .* (1 .- r) .* (1 .+ s) .* e1(1) ./ 8 .+ 
          (1 .+ q) .* (1 .- r) .* (1 .- s) .* e2(-1) ./ 8 .+ (1 .+ q) .* (1 .- r) .* (1 .+ s) .* e2(1) ./ 8 .+ 
          (1 .- q) .* (1 .+ r) .* (1 .- s) .* e3(-1) ./ 8 .+ (1 .- q) .* (1 .+ r) .* (1 .+ s) .* e3(1) ./ 8 .+ 
          (1 .+ q) .* (1 .+ r) .* (1 .- s) .* e4(-1) ./ 8 .+ (1 .+ q) .* (1 .+ r) .* (1 .+ s) .* e4(1) ./ 8
  
    #partial derivatives
    Uq = -f1(r, s) / 2 + f2(r, s) / 2
    Vq = (1 .- r) .* f3q(q, s) / 2 + (1 .+ r) .* f4q(q, s) / 2
    Wq = (1 .- s) .* f5q(q, r) / 2 + (1 .+ s) .* f6q(q, r) / 2
    Ur = (1 .- q) .* f1r(r, s) / 2 + (1 .+ q) .* f2r(r, s) / 2
    Vr = -f3(q, s) / 2 + f4(q, s) / 2
    Wr = (1 .- s) .* f5r(q, r) / 2 + (1 .+ s) .* f6r(q, r) / 2
    Us = (1 .- q) .* f1s(r, s) / 2 + (1 .+ q) .* f2s(r, s) / 2
    Vs = (1 .- r) .* f3s(q, s) / 2 + (1 .+ r) .* f4s(q, s) / 2
    Ws = -f5(q, r) / 2 + f6(q, r) / 2

    UVq = (-1) .* (1 .- r) .* e1(s) / 4 .+ (-1) .* (1 .+ r) .* e3(s) / 4 .+ 
          (1) .* (1 .- r) .* e2(s) / 4 .+ (1) .* (1 .+ r) .* e4(s) / 4
    UVr = (1 .- q) .* (-1) .* e1(s) / 4 .+ (1 .- q) .* (1) .* e3(s) / 4 .+ 
          (1 .+ q) .* (-1) .* e2(s) / 4 .+ (1 .+ q) .* (1) .* e4(s) / 4
    UVs = (1 .- q) .* (1 .- r) .* e1s(s) / 4 .+ (1 .- q) .* (1 .+ r) .* e3s(s) / 4 .+ 
          (1 .+ q) .* (1 .- r) .* e2s(s) / 4 .+ (1 .+ q) .* (1 .+ r) .* e4s(s) / 4
    UWq = (-1) .* (1 .- s) .* e5(r) / 4 .+ (-1) .* (1 .+ s) .* e7(r) / 4 .+ 
          (1) .* (1 .- s) .* e6(r) / 4 .+ (1) .* (1 .+ s) .* e8(r) / 4
    UWr = (1 .- q) .* (1 .- s) .* e5r(r) / 4 .+ (1 .- q) .* (1 .+ s) .* e7r(r) / 4 .+ 
          (1 .+ q) .* (1 .- s) .* e6r(r) / 4 .+ (1 .+ q) .* (1 .+ s) .* e8r(r) / 4
    UWs = (1 .- q) .* (-1) .* e5(r) / 4 .+ (1 .- q) .* (1) .* e7(r) / 4 .+ 
          (1 .+ q) .* (-1) .* e6(r) / 4 .+ (1 .+ q) .* (1) .* e8(r) / 4
    VWq = (1 .- r) .* (1 .- s) .* e9q(q) / 4  .+ (1 .- r) .* (1 .+ s) .* e11q(q) / 4 .+ 
          (1 .+ r) .* (1 .- s) .* e10q(q) / 4 .+ (1 .+ r) .* (1 .+ s) .* e12q(q) / 4
    VWr = (-1) .* (1 .- s) .* e9(q) / 4  .+ (-1) .* (1 .+ s) .* e11(q) / 4 .+ 
          (1) .* (1 .- s) .* e10(q) / 4 .+ (1) .* (1 .+ s) .* e12(q) / 4
    VWs = (1 .- r) .* (-1) .* e9(q) / 4  .+ (1 .- r) .* (1) .* e11(q) / 4 .+ 
          (1 .+ r) .* (-1) .* e10(q) / 4 .+ (1 .+ r) .* (1) .* e12(q) / 4

    UVWq = (-1) .* (1 .- r) .* (1 .- s) .* e1(-1) ./ 8 .+ (-1) .* (1 .- r) .* (1 .+ s) .* e1(1) ./ 8 .+ 
    (1) .* (1 .- r) .* (1 .- s) .* e2(-1) ./ 8 .+ (1) .* (1 .- r) .* (1 .+ s) .* e2(1) ./ 8 .+ 
    (-1) .* (1 .+ r) .* (1 .- s) .* e3(-1) ./ 8 .+ (-1) .* (1 .+ r) .* (1 .+ s) .* e3(1) ./ 8 .+ 
    (1) .* (1 .+ r) .* (1 .- s) .* e4(-1) ./ 8 .+ (1) .* (1 .+ r) .* (1 .+ s) .* e4(1) ./ 8

    UVWr = (1 .- q) .* (-1) .* (1 .- s) .* e1(-1) ./ 8 .+ (1 .- q) .* (-1) .* (1 .+ s) .* e1(1) ./ 8 .+ 
    (1 .+ q) .* (-1) .* (1 .- s) .* e2(-1) ./ 8 .+ (1 .+ q) .* (-1) .* (1 .+ s) .* e2(1) ./ 8 .+ 
    (1 .- q) .* (1) .* (1 .- s) .* e3(-1) ./ 8 .+ (1 .- q) .* (1) .* (1 .+ s) .* e3(1) ./ 8 .+ 
    (1 .+ q) .* (1) .* (1 .- s) .* e4(-1) ./ 8 .+ (1 .+ q) .* (1) .* (1 .+ s) .* e4(1) ./ 8

    UVWs = (1 .- q) .* (1 .- r) .* (-1) .* e1(-1) ./ 8 .+ (1 .- q) .* (1 .- r) .* (1) .* e1(1) ./ 8 .+ 
    (1 .+ q) .* (1 .- r) .* (-1) .* e2(-1) ./ 8 .+ (1 .+ q) .* (1 .- r) .* (1) .* e2(1) ./ 8 .+ 
    (1 .- q) .* (1 .+ r) .* (-1) .* e3(-1) ./ 8 .+ (1 .- q) .* (1 .+ r) .* (1) .* e3(1) ./ 8 .+ 
    (1 .+ q) .* (1 .+ r) .* (-1) .* e4(-1) ./ 8 .+ (1 .+ q) .* (1 .+ r) .* (1) .* e4(1) ./ 8

    ####    
    X =  U + V + W - UW - UV - VW + UVW
    XQ = Uq + Vq + Wq - UWq - UVq - VWq + UVWq
    XR = Ur + Vr + Wr - UWr - UVr - VWr + UVWr
    XS = Us + Vs + Ws - UWs - UVs - VWs + UVWs

    X = X, XQ, XR, XS
  
    return X

  end





#plot wireframe of 6 faces:
#using PyPlot

# mesh(X[1,:,:], Y[1,:,:], Z[1,:, :])  #face 1
# xlabel("x")
# ylabel("y")
# zlabel("z")
# mesh(X[5,:,:], Y[5,:,:], Z[5, :, :])  # face 2

# mesh(X[:,1,:], Y[:,1,:], Z[:, 1, :])  #face 3
# mesh(X[:,5,:], Y[:,5,:], Z[:, 5, :])  # face 4

# mesh(X[:,:,1], Y[:,:,1], Z[:, :, 1])  #face 5
# mesh(X[:,:,5], Y[:,:,5], Z[:, :, 5])  # face 6


